load_module modules/ngx_http_datadog_module.so;

events {
    worker_connections  1024;
}

error_log stderr info;

http {
    # We `add_header` enough (implicitly) that nginx complains that it can't optimize
    # headers using hashes:
    #
    #     nginx: [warn] could not build optimal proxy_headers_hash, you should
    #         increase either proxy_headers_hash_max_size: 512 or
    #         proxy_headers_hash_bucket_size: 64; ignoring
    #         proxy_headers_hash_bucket_size
    #
    # So, the following directive allows more space for the hashing.
    # TODO: Inject this, but when?
    # TODO proxy_headers_hash_bucket_size 128;

    # opentracing on;
    # opentracing_tag http_user_agent $http_user_agent;
    # opentracing_operation_name "$request_method $uri";
    # opentracing_trace_locations off;

    access_log /var/log/nginx/access.log;
    log_format nonsense "I am a fish, feel my wrath!";

    # log_format with_trace_id '$remote_addr - $http_x_forwarded_user [$time_local] "$request" '
    #     '$status $body_bytes_sent "$http_referer" '
    #     '"$http_user_agent" "$http_x_forwarded_for" '
    #     '"$opentracing_context_x_datadog_trace_id" "$opentracing_context_x_datadog_parent_id"';

    datadog {
      "service": "super-duper-nginx",
      "operation_name_override": "nginx.handle",
      "agent_host": "dd-agent",
      "agent_port": 8126
    }

    server {
        listen       80;

        # set $thingy 0;
        # access_log /var/log/nginx/access.log with_trace_id if=$thingy;
        # access_log /var/log/nginx/access.log datadog_json;
        # access_log /var/log/nginx/access.log;

        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
            # datadog_disable;
            datadog_tag "custom-tag" "special value";
        }

        location /test {
            alias /usr/share/nginx/html/index.html;
        }

        location /http {
            # opentracing off;
            # datadog_disable;
            proxy_pass http://http:8080;
            
            add_header X-Cool-Stuff "$opentracing_context_x_datadog_trace_id";
            
            access_log /var/log/nginx/access.log nonsense;
        }

        location /fastcgi {
            fastcgi_pass fastcgi:8080;
            opentracing_operation_name "foobar";
        }
    }

    server {
        listen 1337;

        location /helloworld.Greeter {
            grpc_pass grpc://grpc:8080;
        }
    }
}
